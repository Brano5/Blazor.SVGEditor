@inject IJSRuntime JSRuntime

<ContextMenuTrigger MenuId="SVGMenu" WrapperTag="g" Data=@SVGElement>
    <g transform="translate(@SVGElement.SVG.Translate.x.AsString() @SVGElement.SVG.Translate.y.AsString()) scale(@SVGElement.SVG.Scale.AsString())">
        <polygon tabindex="0"
                 @onfocusin="() => SVGElement.SVG.CurrentShape = SVGElement"
                 @onfocusout="() => SVGElement.SVG.CurrentShape = null"
                 @ref=ElementReference
                 points="@SVGElement.Element.GetAttribute("points")"
                 fill="@SVGElement.Fill"
                 stroke="@SVGElement.Stroke"
                 stroke-width="@SVGElement.StrokeWidth"
                 @onmousedown="Select"
                 @onkeyup="KeyUp" />
    </g>
    @if (SVGElement.Selected && SVGElement.EditMode != EditMode.Add)
    {
        @for (int i = 0; i < SVGElement.Points.Count(); i++)
        {
            var j = i;
            <PrimaryAnchor OnMouseDown="() => AnchorSelect(j)" Position=SVGElement.Points[i] />
        }
    }
</ContextMenuTrigger>


@code {
    [Parameter]
    public Polygon SVGElement { get; set; }

    public ElementReference ElementReference { get; set; }

    public void KeyUp(KeyboardEventArgs eventArgs)
    {
        if (eventArgs.Key == "Delete")
        {
            SVGElement.SVG.Remove(SVGElement);
        }
    }

    public void AnchorSelect(int j)
    {
        if (SVGElement.EditMode != EditMode.Add)
        {
            SVGElement.CurrentAnchor = j;
            SVGElement.EditMode = EditMode.MoveAnchor;
        }
    }

    public async Task Select(MouseEventArgs eventArgs)
    {
        if (SVGElement.SVG.CurrentShape == null || SVGElement.SVG.CurrentShape.EditMode is EditMode.None or EditMode.Scale)
        {
            if (SVGElement.SVG.CurrentShape is not null && SVGElement.SVG.CurrentShape != SVGElement)
            {
                SVGElement.SVG.CurrentShape.EditMode = EditMode.None;
            }
            await JSRuntime.Focus(ElementReference);
            SVGElement.SVG.CurrentShape = SVGElement;
            SVGElement.Panner = SVGElement.SVG.LocalDetransform((eventArgs.OffsetX, eventArgs.OffsetY));
            SVGElement.EditMode = EditMode.Move;
        }
    }

    protected override bool ShouldRender()
    {
        var StateRepresentation = SVGElement.StateRepresentation;
        if (SVGElement._StateRepresentation != StateRepresentation)
        {
            SVGElement._StateRepresentation = StateRepresentation;
            return true;
        }
        return false;
    }
}
