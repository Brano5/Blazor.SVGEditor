@if (SVG.EditGradient is LinearGradient linearGradient && SVG.MarkedShapes.Contains(linearGradient.EditingShape))
{
    <StripedLine Color="grey" From="LinearPoint1(linearGradient)" To="LinearPoint2(linearGradient)" />
    <Anchor Position="LinearPoint1(linearGradient)" RingColor="black" OnPointerDown="_ => GradientEndClicked(linearGradient, -1)" />
    <Anchor Position="LinearPoint2(linearGradient)" RingColor="black" OnPointerDown="_ => GradientEndClicked(linearGradient, -2)" />
    foreach (var s in linearGradient.Stops)
    {
        var stop = s;
        <Anchor Position="Pos(linearGradient, stop)" MiddleColor="@stop.StopColor" RingColor="black" OnPointerDown="_ => StopClicked(linearGradient, stop)" />
    }
}

@code {
    private (double x, double y) Pos(LinearGradient linearGradient, Stop stop) =>
        (
            linearGradient.EditingShape.BoundingBox.X + ((stop.Offset * linearGradient.X2 + (1 - stop.Offset) * linearGradient.X1) * linearGradient.EditingShape.BoundingBox.Width),
            linearGradient.EditingShape.BoundingBox.Y + ((stop.Offset * linearGradient.Y2 + (1 - stop.Offset) * linearGradient.Y1) * linearGradient.EditingShape.BoundingBox.Height)
        );

    private (double x, double y) LinearPoint1(LinearGradient linearGradient) => (linearGradient.EditingShape.BoundingBox.X + linearGradient.X1 * linearGradient.EditingShape.BoundingBox.Width, linearGradient.EditingShape.BoundingBox.Y + linearGradient.Y1 * linearGradient.EditingShape.BoundingBox.Height);
    private (double x, double y) LinearPoint2(LinearGradient linearGradient) => (linearGradient.EditingShape.BoundingBox.X + linearGradient.X2 * linearGradient.EditingShape.BoundingBox.Width, linearGradient.EditingShape.BoundingBox.Y + linearGradient.Y2 * linearGradient.EditingShape.BoundingBox.Height);

    public void StopClicked(LinearGradient linearGradient, Stop stop)
    {
        linearGradient.CurrentStop = linearGradient.Stops.IndexOf(stop);
    }

    public void GradientEndClicked(LinearGradient linearGradient, int end)
    {
        linearGradient.CurrentStop = end;
    }

    [Parameter]
    public SVG SVG { get; set; }
}
